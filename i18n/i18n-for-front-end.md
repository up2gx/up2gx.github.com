##  前端国际化语言包方案探索

### 前言

一个软件产品要想走向国际市场，在不同的国家和地区使用，必然要在软件设计时考虑国际化，那么国际化是啥呢？维基百科中是这样定义的：

> **国际化** 是指在设计软件时，将软件与特定语言及地区脱钩的过程。当软件被移植到不同的语言及地区时，软件本身不用做内部工程上的改变或修正。

这就要求我们在进行软件开发的时候，不能为每个语言环境都开发一个单独的版本，这样浪费了大量的开发成本，而应该将需要翻译和替换的文字、图片等资源从代码中提取出来，通过配置文件的形式进行管理，我们把抽取后的项目成为**国际化通用版项目**，配置文件称为**语言包**，那么**国际化通用版项目** + 不同语言环境的**语言包**就能够使项目支持对应语言环境：

![国际化项目 + 不同语言包](/Users/mark/Desktop/tsc/PPT素材/国际化项目 + 不同语言包.png)

### 现状

有了这个目标，我们再来看目前基于 Vue 前端项目在进行国际化的时候通常是怎么做的，大多数情况下我们都选用的是 Vue 官方推荐的 vue-i18n 方案，常规方式使用 vue-i18n 实现国际化大概需要以下几步：

1. 开发人员使用源语言（中文）开发项目；![image-20210712214332988](/Users/mark/Library/Application Support/typora-user-images/image-20210712214332988.png)
2. 当国际化需求来时，开发人员手动根据源码中的中文抽取语言包定义；![image-20210712214341544](/Users/mark/Library/Application Support/typora-user-images/image-20210712214341544.png)
3. 开发人员将代码中源语言文本改写为对应 key 及标记方法；![image-20210712214401290](/Users/mark/Library/Application Support/typora-user-images/image-20210712214401290.png)
4. 开发人员将源语言包定义整理成翻译人员需要的源语言包，交给翻译人员；
5. 翻译人员翻译完后将目标语言（如英文）包返回给开发人员；
6. 开发人员将目标语言包整理成代码中可用的语言包后，引入项目；![image-20210712214414125](/Users/mark/Library/Application Support/typora-user-images/image-20210712214414125.png)

当出现新的需求的时候，需要不断重复上述过程。

如果是规模比较小的项目的话，手动维护起来可能还比较轻松，一旦有一定规模，维护过程就会变得极其繁琐，而且会出现很多问题。

以我司某大型中台项目为例，在决定采用上述国际化方案后，开始了痛苦的维护工作，在整个国际化需求开发过程中，共计“产出”手动定义语言包文件**120**余个，国际化相关bug**180**余个。

### 痛点分析

在经历了如此开发过程后，我们总结出上述方案在大型项目中应用的以下几个问题：

1. 抽取语言包的过程需要开发人员手动操作，过程繁琐且开发效率低；
2. 代码中充斥大量 key ，不符合中文阅读习惯，维护成本高；
3. 全量加载语言包，导致用户体验差；



出现这些问题的主要原因，还是我们事先没有很好的思考采用现有方案可能带来的问题，并对此进行调研、设计，也是在项目磕磕绊绊上线后，才回过头来思考我们期望的国际化方案应该是什么样的，与上述痛点对应，大概有以下几条：

1. 自动化工具代替大量手动抽取语言包的操作；
2. 最好能在项目中直接用源语言书写代码，以增强代码可读性；
3. 按需加载对应语言环境语言包；



### 调研

根据以上需求，我们调研了目前开源的前端国际化方案，发现大致可以分为两种：

1. 不同语言编译成不同制品，部署到不同环境，代表的有 Angular i18n；
2. 编译成一个制品，运行时根据语言环境加载对应语言资源，代表的有 Vue-i18n 、i18next、kiwi等；

![前端国际化方案分类](/Users/mark/Desktop/tsc/PPT素材/前端国际化方案分类.png)

Angular i18n 是这么做国际化的：

1. 使用源语言开发项目，并标记出需要翻译的部分，对于其中一些比较复杂的翻译场景（不同的语言有不同的复数规则和语法结构）用 **ICU** 消息格式进行标记；
2. 用 CLI 命令把标记过的文本提取到 **XLIFF** 语言包中；
3. 把 **XLIFF** 语言包为每种语言复制一份，并把这些 **XLIFF** 语言包发给翻译人员或翻译服务；
4. 在为一个或多个本地环境构建应用时，使用 CLI 合并这些翻译完成的文件；

整个过程相对比较方便，且解决了我们上面提到的一些需求，如用自动化指令抽取语言包来代替大量手动操作及用源语言标记翻译代码的需求。

> 其中涉及到的一些缩写（XLIFF/ICU/BCP47）都是一些国际化领域标准的解决方案，这里做一些简单介绍：
>
> #### XLIFF 
>
> **XLIFF**（**XML Localisation Interchange File Format**，即XML本地化交换文件格式）是一种基于XML的交换格式，旨在标准化国际化、本地化过程中在工具之间传递可本地化数据的方式。
>
> 其中可以包含一些给翻译人员提供的附加信息，使翻译人员能够更好地翻译
>
> ![image-20210713141926565](/Users/mark/Library/Application Support/typora-user-images/image-20210713141926565.png)
>
> 同时，也是因为 **XLIFF** 是一种标准的解决方案，应用市场上也衍生了一部分给翻译人员使用的 **XLIFF** 翻译工具，如 **XLIFF editor、Poeditor** 等，图中展示的是 **XLIFF editor** 的用法：
>
> ![image-20210713142412118](/Users/mark/Library/Application Support/typora-user-images/image-20210713142412118.png)
>
> #### ICU
>
> 为了国际化过程中需要根据各地的风俗和语言习惯，实现对数字、货币、时间、日期、和消息的格式化、解析，对字符串进行大小写转换、整理、搜索和排序等功能，**ICU** （International Components for Unicode，Unicode 国际化标准组件）应运而生，它其实是一套成熟、广泛使用的C/C++、Java和.NET 类库集。但我们可以利用其所提供的 [ICU 消息格式](http://userguide.icu-project.org/formatparse/messages) 定义解决我们翻译中常见的复数、选择占位等复杂形式，下图所示是用 **ICU消息格式** 表示复数的一种场景：
>
> ![image-20210713150931203](/Users/mark/Library/Application Support/typora-user-images/image-20210713150931203.png)

但是，**Angluar i18n** 的方案应用到我们的项目也有一些问题：

1. 只提供了模版中的标记方法，对于逻辑中的文本，并没有提供一个官方的解决方案；
2. 在编译时编译成不同的制品，无法满足运行时切换不同语言环境的需求；
3. 我们的项目大多都是基于 Vue 开发的；

### 思考

结合以上调研的信息，我们进行了一些思考，发现前端国际化围绕语言包大致可分为两部分，即 **生产语言包** 和 **消费语言包** ，现有的前端国际化方案，在 **生产语言包** 和 **消费语言包** 





